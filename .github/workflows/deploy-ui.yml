name: Rameda UI - Complete CI/CD Pipeline

on:
  workflow_dispatch:
    inputs:
      version_type:
        description: 'Version bump type'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major
      skip_tests:
        description: 'Skip tests (use with caution)'
        required: false
        default: false
        type: boolean

# Grant TOKEN write permissions for version commits
permissions:
  contents: write

env:
  PROJECT_ID: rameda-465221
  LOCATION: europe-west3
  BUCKET: rameda-ui-static
  IMAGE_NAME: europe-west3-docker.pkg.dev/rameda-465221/gcr/rameda-ui

jobs:
  # Job 1: Bump Version
  bump-version:
    name: ğŸ”¢ Bump Version
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main'
    outputs:
      new_version: ${{ steps.bump-version.outputs.new_version }}
      version_changed: ${{ steps.bump-version.outputs.version_changed }}
    steps:
      - name: ğŸ“¦ Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GIT_ACCESS_TOKEN }}
          fetch-depth: 0

      - name: ğŸ”¢ Bump version
        id: bump-version
        run: |
          # Read current version or create if doesn't exist
          if [[ -f VERSION ]]; then
            CURRENT_VERSION=$(cat VERSION | tr -d '\n\r')
            echo "Current version: $CURRENT_VERSION"
          else
            echo "VERSION file not found, creating with initial version 0.1.0"
            CURRENT_VERSION="0.1.0"
            echo "$CURRENT_VERSION" > VERSION
          fi

          # Split version into parts
          IFS='.' read -ra VERSION_PARTS <<< "$CURRENT_VERSION"
          MAJOR=${VERSION_PARTS[0]}
          MINOR=${VERSION_PARTS[1]}
          PATCH=${VERSION_PARTS[2]}

          # Increment version based on input
          case "${{ github.event.inputs.version_type }}" in
            "major")
              NEW_MAJOR=$((MAJOR + 1))
              NEW_VERSION="$NEW_MAJOR.0.0"
              ;;
            "minor")
              NEW_MINOR=$((MINOR + 1))
              NEW_VERSION="$MAJOR.$NEW_MINOR.0"
              ;;
            "patch"|*)
              NEW_PATCH=$((PATCH + 1))
              NEW_VERSION="$MAJOR.$MINOR.$NEW_PATCH"
              ;;
          esac

          echo "New version: $NEW_VERSION"
          echo "$NEW_VERSION" > VERSION
          
          # Set outputs
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "version_changed=true" >> $GITHUB_OUTPUT

      - name: ğŸ“ Commit version changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action Bot"
          git add VERSION
          git commit -m "ğŸ”– Bump ${{ github.event.inputs.version_type }} version to v${{ steps.bump-version.outputs.new_version }}"

      - name: ğŸ“¤ Push changes
        run: |
          git push origin HEAD

  # Job 2: Run Tests & Linting (always runs, but can skip actual tests)
  test:
    name: ğŸ§ª Run Tests & Linting
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: bump-version
    outputs:
      tests_skipped: ${{ steps.test-result.outputs.tests_skipped }}
    steps:
      - name: ğŸ“¦ Checkout repository (latest)
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: ğŸŸ¨ Setup Bun
        if: ${{ github.event.inputs.skip_tests != 'true' }}
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: ğŸ“š Install dependencies
        if: ${{ github.event.inputs.skip_tests != 'true' }}
        run: |
          bun install --frozen-lockfile

      - name: ğŸ” Type checking
        if: ${{ github.event.inputs.skip_tests != 'true' }}
        run: |
          bun run tsc --noEmit

      - name: ğŸ§¹ Lint check
        if: ${{ github.event.inputs.skip_tests != 'true' }}
        run: |
          bun run lint

      - name: ğŸ§ª Run tests
        if: ${{ github.event.inputs.skip_tests != 'true' }}
        run: |
          # Only run if test script exists in package.json
          if bun run --silent test --help >/dev/null 2>&1; then
            echo "Running tests..."
            bun run test
          else
            echo "No test script found, skipping tests"
          fi

      - name: ğŸ—ï¸ Build check
        if: ${{ github.event.inputs.skip_tests != 'true' }}
        run: |
          # Test build to ensure it works
          VITE_BASE_URL="https://storage.googleapis.com/rameda-ui-static/static/test/" bun run build
          
          # Check if build artifacts exist
          if [ ! -f "dist/index.html" ]; then
            echo "âŒ Build failed: index.html not found!"
            exit 1
          fi
          
          echo "âœ… Build successful!"

      - name: ğŸ“Š Upload build artifacts
        if: ${{ github.event.inputs.skip_tests != 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: build-check-artifacts
          path: |
            dist/
          retention-days: 1

      - name: â­ï¸ Skip tests notification
        if: ${{ github.event.inputs.skip_tests == 'true' }}
        run: |
          echo "âš ï¸ Tests were skipped by user request"

      - name: ğŸ“ Set test result
        id: test-result
        run: |
          SKIP_TESTS="${{ github.event.inputs.skip_tests }}"
          if [[ "$SKIP_TESTS" == "true" ]]; then
            echo "tests_skipped=true" >> $GITHUB_OUTPUT
          else
            echo "tests_skipped=false" >> $GITHUB_OUTPUT
          fi

  # Job 3: Build and Push Docker Image
  build-and-push:
    name: ğŸ³ Build & Push Docker Image
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [bump-version, test]
    if: needs.test.result == 'success'
    outputs:
      image_tag: ${{ env.IMAGE_NAME }}:v${{ needs.bump-version.outputs.new_version }}
    steps:
      - name: ğŸ“¦ Checkout repository (latest)
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: ğŸŸ¨ Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: ğŸ” Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: âš™ï¸ Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      - name: ğŸ³ Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker ${{ env.LOCATION }}-docker.pkg.dev --quiet

      - name: ğŸ“š Install dependencies
        run: |
          bun install --frozen-lockfile

      - name: ğŸ—ï¸ Build UI project
        run: |
          VERSION="${{ needs.bump-version.outputs.new_version }}"
          PUBLIC_URL="https://storage.googleapis.com/${{ env.BUCKET }}/static/v${VERSION}"
          echo "ğŸ”§ Building UI with VITE_BASE_URL=${PUBLIC_URL}/"
          VITE_BASE_URL="${PUBLIC_URL}/" bun run build

      - name: â˜ï¸ Upload static assets to GCS
        timeout-minutes: 10
        run: |
          VERSION="${{ needs.bump-version.outputs.new_version }}"
          STATIC_PATH="static/v${VERSION}"
          
          echo "ğŸš€ Uploading to GCS: $STATIC_PATH"
          
          # Check if build directory exists
          if [ ! -d "dist" ]; then
            echo "âŒ dist directory not found!"
            exit 1
          fi
          
          # Upload assets if they exist
          if [ -d "dist/assets" ]; then
            echo "ğŸ“¦ Uploading assets..."
            gsutil -m cp -r "dist/assets" "gs://${{ env.BUCKET }}/${STATIC_PATH}/"
          fi
          
          # Upload JS files
          if ls dist/*.js 1> /dev/null 2>&1; then
            echo "ğŸ“¦ Uploading JS files..."
            gsutil -m cp dist/*.js "gs://${{ env.BUCKET }}/${STATIC_PATH}/"
          fi
          
          # Upload CSS files
          if ls dist/*.css 1> /dev/null 2>&1; then
            echo "ğŸ“¦ Uploading CSS files..."
            gsutil -m cp dist/*.css "gs://${{ env.BUCKET }}/${STATIC_PATH}/"
          fi
          
          # Set caching headers
          echo "âš™ï¸ Setting cache headers..."
          gsutil -m setmeta -h "Cache-Control:public,max-age=31536000,immutable" "gs://${{ env.BUCKET }}/${STATIC_PATH}/**" 2>/dev/null || echo "âš ï¸ Warning: could not set cache headers"

      - name: ğŸ³ Build and push Docker image
        timeout-minutes: 15
        run: |
          VERSION="${{ needs.bump-version.outputs.new_version }}"
          IMAGE_TAG="${{ env.IMAGE_NAME }}:v${VERSION}"
          IMAGE_LATEST="${{ env.IMAGE_NAME }}:latest"
          
          # Create temporary directory for Docker build
          TMPDIR=$(mktemp -d)
          mkdir -p "$TMPDIR/app"
          
          # Check that index.html exists
          if [ ! -f "dist/index.html" ]; then
            echo "âŒ dist/index.html not found!"
            rm -rf "$TMPDIR"
            exit 1
          fi
          
          # Copy index.html to temp directory
          cp "dist/index.html" "$TMPDIR/app/"
          
          # Create Dockerfile
          cat > "$TMPDIR/Dockerfile" <<EOF
          FROM nginx:1.25-alpine
          COPY app/index.html /usr/share/nginx/html/index.html
          RUN rm -rf /etc/nginx/conf.d/* && \\
              echo 'server { listen 8080; root /usr/share/nginx/html; index index.html; location / { try_files \$uri /index.html; } }' > /etc/nginx/conf.d/default.conf
          EXPOSE 8080
          EOF
          
          echo "ğŸ³ Building Docker image: $IMAGE_TAG"
          docker build -t "$IMAGE_TAG" "$TMPDIR"
          
          echo "ğŸš€ Pushing Docker image to Artifact Registry..."
          docker push "$IMAGE_TAG"
          
          echo "ğŸ·ï¸ Creating latest tag..."
          docker tag "$IMAGE_TAG" "$IMAGE_LATEST"
          docker push "$IMAGE_LATEST"
          
          # Cleanup
          rm -rf "$TMPDIR"
          
          echo "âœ… Docker image built and pushed successfully!"

  # Job 4: Deploy to Kubernetes
  deploy:
    name: ğŸš€ Deploy to Kubernetes
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [bump-version, build-and-push]
    if: needs.build-and-push.result == 'success'
    steps:
      - name: ğŸ“¦ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ” Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: âš™ï¸ Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      - name: ğŸ¯ Get GKE credentials
        run: |
          gcloud container clusters get-credentials autopilot-cluster-1 --region=europe-west3

      - name: ğŸ”„ Restart deployment
        run: |
          kubectl rollout restart deployment rameda-ui -n rameda-ui
          kubectl rollout status deployment rameda-ui -n rameda-ui --timeout=300s

      - name: âœ… Verify deployment
        run: |
          echo "ğŸ” Checking deployment status..."
          kubectl get pods -n rameda-ui
          kubectl get svc -n rameda-ui

  # Job 5: Create Release
  release:
    name: ğŸ“‹ Create GitHub Release
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [bump-version, build-and-push, deploy]
    if: needs.deploy.result == 'success'
    steps:
      - name: ğŸ“¦ Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GIT_ACCESS_TOKEN }}
          ref: main
          fetch-depth: 0

      - name: ğŸ·ï¸ Create Git tag
        run: |
          VERSION="${{ needs.bump-version.outputs.new_version }}"
          git tag "v$VERSION"
          git push origin "v$VERSION"

      - name: ğŸ“‹ Create GitHub Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GIT_ACCESS_TOKEN }}
        with:
          tag_name: v${{ needs.bump-version.outputs.new_version }}
          release_name: Release v${{ needs.bump-version.outputs.new_version }}
          body: |
            ğŸš€ Deployed version v${{ needs.bump-version.outputs.new_version }}
            
            ğŸ“ **Static assets:** https://storage.googleapis.com/${{ env.BUCKET }}/static/v${{ needs.bump-version.outputs.new_version }}/
            ğŸ³ **Docker image:** ${{ env.IMAGE_NAME }}:v${{ needs.bump-version.outputs.new_version }}
            ğŸ“¦ **All images:** ${{ env.LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/gcr/
            
            ### Changes
            - Automated deployment from commit ${{ github.sha }}
          draft: false
          prerelease: false

  # Job 6: Notifications and Summary
  notify:
    name: ğŸ“¢ Notify & Summary
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [bump-version, test, build-and-push, deploy, release]
    if: always()
    steps:
      - name: ğŸ“Š Prepare summary
        run: |
          echo "## ğŸš€ Rameda UI Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "| Step | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Version Bump | ${{ needs.bump-version.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Tests & Linting | ${{ needs.test.outputs.tests_skipped == 'true' && 'â­ï¸ Skipped' || (needs.test.result == 'success' && 'âœ…' || 'âŒ') }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build & Push | ${{ needs.build-and-push.result == 'success' && 'âœ…' || (needs.build-and-push.result == 'failure' && 'âŒ' || 'â­ï¸ Skipped') }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Deploy | ${{ needs.deploy.result == 'success' && 'âœ…' || (needs.deploy.result == 'failure' && 'âŒ' || 'â­ï¸ Skipped') }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Release | ${{ needs.release.result == 'success' && 'âœ…' || (needs.release.result == 'failure' && 'âŒ' || 'â­ï¸ Skipped') }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** v${{ needs.bump-version.outputs.new_version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** \`${{ env.IMAGE_NAME }}:v${{ needs.bump-version.outputs.new_version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Static URL:** https://storage.googleapis.com/${{ env.BUCKET }}/static/v${{ needs.bump-version.outputs.new_version }}/" >> $GITHUB_STEP_SUMMARY
          echo "**App URL:** https://rameda.pro" >> $GITHUB_STEP_SUMMARY

      - name: ğŸ”” Send success notification
        if: ${{ needs.deploy.result == 'success' }}
        uses: appleboy/telegram-action@v0.1.1
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: |
            ğŸš€ *Rameda UI Successfully Deployed!*
            
            ğŸ“¦ *Version:* v${{ needs.bump-version.outputs.new_version }}
            ğŸ³ *Image:* `${{ env.IMAGE_NAME }}:v${{ needs.bump-version.outputs.new_version }}`
            ğŸŒ *App:* https://rameda.pro
            ğŸ“ *Static:* https://storage.googleapis.com/${{ env.BUCKET }}/static/v${{ needs.bump-version.outputs.new_version }}/
            ğŸ§ª *Tests:* ${{ needs.test.outputs.tests_skipped == 'true' && 'Skipped' || 'Passed' }}
            
            [View Workflow](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
          format: markdown

      - name: ğŸš¨ Send failure notification
        if: ${{ needs.build-and-push.result == 'failure' || needs.deploy.result == 'failure' || needs.test.result == 'failure' }}
        uses: appleboy/telegram-action@v0.1.1
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: |
            âŒ *Rameda UI Deployment Failed!*
            
            ğŸ“¦ *Version:* v${{ needs.bump-version.outputs.new_version }}
            ğŸš« *Failed Step:* ${{ needs.test.result == 'failure' && 'Tests' || (needs.build-and-push.result == 'failure' && 'Build & Push' || 'Deploy') }}
            
            [View Workflow](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
          format: markdown 